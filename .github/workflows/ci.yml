name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Go mod download
        run: go mod download
      - name: Go vet & test
        run: |
          gofmt -l . | tee fmt.txt
          test ! -s fmt.txt
          go vet ./...
          go test ./...
      - name: Go benchmarks (sanity)
        run: go test ./internal/peer -bench . -benchtime=100ms
      - name: Node unit tests
        run: |
          cd internal/peer/webui/static
          if [ -f package.json ]; then
            npm install
          fi
          node ui/__tests__/theme.test.mjs
          node ui/__tests__/settings.test.mjs
